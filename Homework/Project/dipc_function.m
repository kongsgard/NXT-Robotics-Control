function [ dX ] = dipc_function( t, X )

x        = X(1);
theta_1  = X(2);
theta_2  = X(3);
dx       = X(4);
dtheta_1 = X(5);
dtheta_2 = X(6);

% Kart parameters
h_0 = 1;
b_0 = 0.8;
l_0 = 2;
m_0 = 1;
I_0 = (1/12)*m_0*(h_0^2 + b_0^2);
% Link 1 parameters
l_1 = 1.5;
m_1 = 1; 
I_1 = (1/3)*m_1*l_1^2;
% Link 2 parameters
l_2 = 1.5;
m_2 = 1;
I_2 = (1/3)*m_2*l_2^2;
% Other parameters
g = 9.81;
tau = 0;

syms d2x d2theta_1 d2theta_2

eqn1 = d2x == (tau + (m_2*(sin(theta_2)*dtheta_2^2*l_2^2 + ...
    sin(conj(theta_2))*abs(dtheta_2)^2*abs(l_2)^2))/(4*l_2) + ...
    ((sin(theta_1)*dtheta_1^2*l_1^2 + ...
    sin(conj(theta_1))*abs(dtheta_1)^2*abs(l_1)^2)*(m_1 + 2*m_2))/(4*l_1) - ...
    (d2theta_2*m_2*(cos(theta_2)*l_2^2 + ...
    cos(conj(theta_2))*abs(l_2)^2))/(4*l_2) - ...
    (d2theta_1*(cos(theta_1)*l_1^2 + ...
    cos(conj(theta_1))*abs(l_1)^2)*(m_1 + 2*m_2))/(4*l_1))/(m_0 + m_1 + m_2);

eqn2 = d2theta_1 == -((d2x*m_1*cos(conj(theta_1))*conj(l_1))/4 - ...
    l_1*m_2*sin(theta_1) - (l_1*m_1*sin(theta_1))/2 + ...
    (d2x*m_2*cos(conj(theta_1))*conj(l_1))/2 + ...
    (d2x*l_1*m_1*cos(theta_1))/4 + ...
    (d2x*l_1*m_2*cos(theta_1))/2 + ...
    (dx*m_1*sin(conj(theta_1))*conj(dtheta_1)*conj(l_1))/4 + ...
    (dx*m_2*sin(conj(theta_1))*conj(dtheta_1)*conj(l_1))/2 - ...
    (dtheta_2^2*l_2*m_2*sin(theta_2 - conj(theta_1))*conj(l_1))/4 + ...
    (l_1*m_2*sin(theta_1 - conj(theta_2))*abs(dtheta_2)^2*conj(l_2))/4 - ...
    (dtheta_1*dx*m_1*sin(conj(theta_1))*conj(l_1))/4 - ...
    (dtheta_1*dx*m_2*sin(conj(theta_1))*conj(l_1))/2 + ...
    (d2theta_2*l_1*m_2*cos(theta_1 - conj(theta_2))*conj(l_2))/4 + ...
    (d2theta_2*l_2*m_2*cos(theta_2 - conj(theta_1))*conj(l_1))/4 + ...
    (dtheta_1*dtheta_2*l_2*m_2*sin(theta_2 - conj(theta_1))*conj(l_1))/4 - ...
    (dtheta_2*l_2*m_2*sin(theta_2 - conj(theta_1))*conj(dtheta_1)*conj(l_1))/4)/(I_1 + (m_1*cos(theta_1 - conj(theta_1))*abs(l_1)^2)/4 + ...
    m_2*cos(theta_1 - conj(theta_1))*abs(l_1)^2);

eqn3 = d2theta_2 == -((d2x*m_2*cos(conj(theta_2))*conj(l_2))/4 - ...
    (m_2*sin(theta_2))/2 + (d2x*l_2*m_2*cos(theta_2))/4 + ...
    (dx*m_2*sin(conj(theta_2))*conj(dtheta_2)*conj(l_2))/4 - ...
    (dtheta_1^2*l_1*m_2*sin(theta_1 - conj(theta_2))*conj(l_2))/4 + ...
    (l_2*m_2*sin(theta_2 - conj(theta_1))*abs(dtheta_1)^2*conj(l_1))/4 - ...
    (dtheta_2*dx*m_2*sin(conj(theta_2))*conj(l_2))/4 + ...
    (d2theta_1*l_1*m_2*cos(theta_1 - conj(theta_2))*conj(l_2))/4 + ...
    (d2theta_1*l_2*m_2*cos(theta_2 - conj(theta_1))*conj(l_1))/4 + ...
    (dtheta_1*dtheta_2*l_1*m_2*sin(theta_1 - conj(theta_2))*conj(l_2))/4 - ...
    (dtheta_1*l_1*m_2*sin(theta_1 - conj(theta_2))*conj(dtheta_2)*conj(l_2))/4)/(I_2 + (m_2*cos(theta_2 - conj(theta_2))*abs(l_2)^2)/4);

sol = solve([eqn1, eqn2, eqn3], [d2x, d2theta_1, d2theta_2]);

d2x = sol.d2x;
d2theta_1 = sol.d2theta_1;
d2theta_2 = sol.d2theta_2;

dX = [dx; dtheta_1; dtheta_2; d2x; d2theta_1; d2theta_2];

end

